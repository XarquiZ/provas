<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prova Online</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <img src="LOGO_1-8.png" alt="Logo da Instituição" class="logo">
        <div id="timer" class="timer">60:00</div>

        <!-- Tela Inicial -->
        <section id="loginSection">
            <div class="title-section">Prova de Avaliação de Conhecimentos</div>
            <h1>Bem-vindo(a)</h1>
            <div class="role-buttons">
                <button id="studentBtn">Entrar como Aluno</button>
                <button id="professorBtn">Entrar como Professor</button>
            </div>
        </section>

        <!-- Seção de Senha do Professor -->
        <section id="passwordSection">
            <div class="title-section">Prova de Avaliação de Conhecimentos</div>
            <h1>Login do Professor</h1>
            <form id="passwordForm">
                <div class="form-group">
                    <label for="profPassword">Senha:</label>
                    <input type="password" id="profPassword" required placeholder="Digite a senha">
                </div>
                <button type="submit">Entrar</button>
            </form>
        </section>

        <!-- Seção de Dados do Aluno -->
        <section id="dadosSection">
            <div class="title-section">Prova de Avaliação de Conhecimentos</div>
            <h1>Dados do Aluno</h1>
            <form id="dadosForm">
                <div class="form-group">
                    <label for="nome">Nome Completo:</label>
                    <input type="text" id="nome" required>
                </div>
                <div class="form-group">
                    <label for="email">E-mail:</label>
                    <input type="email" id="email" required placeholder="exemplo@dominio.com">
                </div>
                <div class="form-group">
                    <label for="turma">Turma:</label>
                    <select id="turma" required>
                        <option value="">Selecione sua turma</option>
                        <option value="Operador de Microcomputador">Operador de Microcomputador</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="periodo">Período:</label>
                    <select id="periodo" required>
                        <option value="">Selecione o período</option>
                        <option value="Manhã">Manhã</option>
                        <option value="Tarde">Tarde</option>
                        <option value="Noite">Noite</option>
                    </select>
                </div>
                <button type="submit">Continuar</button>
            </form>
        </section>

        <!-- Seção de Perguntas -->
        <section id="perguntasSection">
            <div class="title-section">Prova de Avaliação de Conhecimentos</div>
            <h1>Prova Online</h1>
            <div id="progress"></div>

            <!-- Perguntas para Operador de Microcomputador -->
            <div id="opMicroQ1" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 1 - Operador de Microcomputador</h3>
                <p>O que é um processador?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ1" value="a"> a) Dispositivo de armazenamento</label>
                    <label><input type="radio" name="opMicroQ1" value="b"> b) Unidade de processamento central</label>
                    <label><input type="radio" name="opMicroQ1" value="c"> c) Placa de vídeo</label>
                    <label><input type="radio" name="opMicroQ1" value="d"> d) Fonte de energia</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ2" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 2 - Operador de Microcomputador</h3>
                <p>Qual é a função principal da memória RAM?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ2" value="a"> a) Armazenar dados permanentemente</label>
                    <label><input type="radio" name="opMicroQ2" value="b"> b) Armazenar dados temporariamente</label>
                    <label><input type="radio" name="opMicroQ2" value="c"> c) Processar gráficos</label>
                    <label><input type="radio" name="opMicroQ2" value="d"> d) Gerenciar energia</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ3" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 3 - Operador de Microcomputador</h3>
                <p>O que conecta os componentes na placa-mãe?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ3" value="a"> a) Cooler</label>
                    <label><input type="radio" name="opMicroQ3" value="b"> b) Barramentos</label>
                    <label><input type="radio" name="opMicroQ3" value="c"> c) Cabo HDMI</label>
                    <label><input type="radio" name="opMicroQ3" value="d"> d) Fonte</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ4" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 4 - Operador de Microcomputador</h3>
                <p>Qual é a função do HD?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ4" value="a"> a) Armazenamento permanente de dados</label>
                    <label><input type="radio" name="opMicroQ4" value="b"> b) Processamento de dados</label>
                    <label><input type="radio" name="opMicroQ4" value="c"> c) Refrigeração</label>
                    <label><input type="radio" name="opMicroQ4" value="d"> d) Conexão à internet</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ5" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 5 - Operador de Microcomputador</h3>
                <p>O que a fonte de alimentação faz?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ5" value="a"> a) Converte energia elétrica para os componentes</label>
                    <label><input type="radio" name="opMicroQ5" value="b"> b) Armazena dados</label>
                    <label><input type="radio" name="opMicroQ5" value="c"> c) Processa gráficos</label>
                    <label><input type="radio" name="opMicroQ5" value="d"> d) Conecta à rede</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ6" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 6 - Operador de Microcomputador</h3>
                <p>Qual é a principal função da GPU?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ6" value="a"> a) Processar cálculos gerais</label>
                    <label><input type="radio" name="opMicroQ6" value="b"> b) Processar gráficos</label>
                    <label><input type="radio" name="opMicroQ6" value="c"> c) Armazenar dados</label>
                    <label><input type="radio" name="opMicroQ6" value="d"> d) Gerenciar energia</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ7" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 7 - Operador de Microcomputador</h3>
                <p>Para que servem as portas USB?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ7" value="a"> a) Conectar periféricos</label>
                    <label><input type="radio" name="opMicroQ7" value="b"> b) Refrigeração</label>
                    <label><input type="radio" name="opMicroQ7" value="c"> c) Processamento</label>
                    <label><input type="radio" name="opMicroQ7" value="d"> d) Armazenamento</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ8" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 8 - Operador de Microcomputador</h3>
                <p>O que o cooler faz no computador?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ8" value="a"> a) Armazena dados</label>
                    <label><input type="radio" name="opMicroQ8" value="b"> b) Resfria os componentes</label>
                    <label><input type="radio" name="opMicroQ8" value="c"> c) Conecta à internet</label>
                    <label><input type="radio" name="opMicroQ8" value="d"> d) Processa gráficos</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ9" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 9 - Operador de Microcomputador</h3>
                <p>Qual é a principal vantagem do SSD sobre o HD?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ9" value="a"> a) Maior capacidade</label>
                    <label><input type="radio" name="opMicroQ9" value="b"> b) Maior velocidade</label>
                    <label><input type="radio" name="opMicroQ9" value="c"> c) Menor custo</label>
                    <label><input type="radio" name="opMicroQ9" value="d"> d) Menor tamanho</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ10" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 10 - Operador de Microcomputador</h3>
                <p>O que o BIOS faz ao ligar o computador?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ10" value="a"> a) Inicia o sistema operacional</label>
                    <label><input type="radio" name="opMicroQ10" value="b"> b) Armazena dados</label>
                    <label><input type="radio" name="opMicroQ10" value="c"> c) Processa gráficos</label>
                    <label><input type="radio" name="opMicroQ10" value="d"> d) Conecta periféricos</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ11" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 11 - Operador de Microcomputador</h3>
                <p>Qual é a função da placa de rede?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ11" value="a"> a) Conectar o computador a uma rede</label>
                    <label><input type="radio" name="opMicroQ11" value="b"> b) Armazenar dados</label>
                    <label><input type="radio" name="opMicroQ11" value="c"> c) Refrigeração</label>
                    <label><input type="radio" name="opMicroQ11" value="d"> d) Processamento</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ12" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 12 - Operador de Microcomputador</h3>
                <p>O que diferencia hardware de software?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ12" value="a"> a) Hardware é físico, software é lógico</label>
                    <label><input type="radio" name="opMicroQ12" value="b"> b) Hardware é lógico, software é físico</label>
                    <label><input type="radio" name="opMicroQ12" value="c"> c) Ambos são físicos</label>
                    <label><input type="radio" name="opMicroQ12" value="d"> d) Ambos são lógicos</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ13" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 13 - Operador de Microcomputador</h3>
                <p>O que é um barramento?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ13" value="a"> a) Conexão entre componentes</label>
                    <label><input type="radio" name="opMicroQ13" value="b"> b) Dispositivo de armazenamento</label>
                    <label><input type="radio" name="opMicroQ13" value="c"> c) Processador</label>
                    <label><input type="radio" name="opMicroQ13" value="d"> d) Cooler</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ14" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 14 - Operador de Microcomputador</h3>
                <p>Qual é a função da memória cache?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ14" value="a"> a) Armazenar dados permanentemente</label>
                    <label><input type="radio" name="opMicroQ14" value="b"> b) Acelerar o acesso a dados</label>
                    <label><input type="radio" name="opMicroQ14" value="c"> c) Conectar periféricos</label>
                    <label><input type="radio" name="opMicroQ14" value="d"> d) Processar gráficos</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ15" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 15 - Operador de Microcomputador</h3>
                <p>Para que servem os conectores SATA?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ15" value="a"> a) Conectar dispositivos de armazenamento</label>
                    <label><input type="radio" name="opMicroQ15" value="b"> b) Refrigeração</label>
                    <label><input type="radio" name="opMicroQ15" value="c"> c) Conexão à internet</label>
                    <label><input type="radio" name="opMicroQ15" value="d"> d) Processamento</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ16" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 16 - Operador de Microcomputador</h3>
                <p>Qual é a função principal de um monitor?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ16" value="a"> a) Exibir informações visuais</label>
                    <label><input type="radio" name="opMicroQ16" value="b"> b) Armazenar dados</label>
                    <label><input type="radio" name="opMicroQ16" value="c"> c) Processar dados</label>
                    <label><input type="radio" name="opMicroQ16" value="d"> d) Gerenciar energia</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ17" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 17 - Operador de Microcomputador</h3>
                <p>O que a placa de som faz?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ17" value="a"> a) Processa áudio</label>
                    <label><input type="radio" name="opMicroQ17" value="b"> b) Armazena dados</label>
                    <label><input type="radio" name="opMicroQ17" value="c"> c) Conecta à rede</label>
                    <label><input type="radio" name="opMicroQ17" value="d"> d) Refrigera o sistema</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ18" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 18 - Operador de Microcomputador</h3>
                <p>O que é um periférico?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ18" value="a"> a) Dispositivo externo conectado ao computador</label>
                    <label><input type="radio" name="opMicroQ18" value="b"> b) Componente interno essencial</label>
                    <label><input type="radio" name="opMicroQ18" value="c"> c) Software de sistema</label>
                    <label><input type="radio" name="opMicroQ18" value="d"> d) Fonte de energia</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ19" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 19 - Operador de Microcomputador</h3>
                <p>Qual é a função principal do gabinete?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ19" value="a"> a) Proteger e organizar componentes</label>
                    <label><input type="radio" name="opMicroQ19" value="b"> b) Processar dados</label>
                    <label><input type="radio" name="opMicroQ19" value="c"> c) Armazenar dados</label>
                    <label><input type="radio" name="opMicroQ19" value="d"> d) Conectar à internet</label>
                </div>
                <button class="submitAnswer">Enviar Resposta</button>
            </div>
            <div id="opMicroQ20" class="question">
                <div class="title-section">Prova de Avaliação de Conhecimentos</div>
                <h3>Questão 20 - Operador de Microcomputador</h3>
                <p>Qual é o método mais seguro para limpar um teclado?</p>
                <div class="options">
                    <label><input type="radio" name="opMicroQ20" value="a"> a) Usar ar comprimido</label>
                    <label><input type="radio" name="opMicroQ20" value="b"> b) Lavar com água</label>
                    <label><input type="radio" name="opMicroQ20" value="c"> c) Usar aspirador</label>
                    <label><input type="radio" name="opMicroQ20" value="d"> d) Mergulhar em álcool</label>
                </div>
                <!-- Botão "Enviar Resposta" removido -->
            </div>

            <div class="navigation">
                <button id="prevBtn" style="display: none;">Voltar</button>
                <button id="finishBtn" style="display: none;">Finalizar Prova</button>
            </div>
        </section>

        <!-- Seção do Professor -->
        <section id="professorSection">
            <div class="title-section">Prova de Avaliação de Conhecimentos</div>
            <h1>Painel do Professor</h1>
            <div class="form-group">
                <label for="exportTurma">Selecionar Turma:</label>
                <select id="exportTurma">
                    <option value="">Todas as Turmas</option>
                    <option value="Operador de Microcomputador">Operador de Microcomputador</option>
                </select>
            </div>
            <div class="form-group">
                <label for="exportPeriodo">Selecionar Período:</label>
                <select id="exportPeriodo">
                    <option value="">Todos os Períodos</option>
                    <option value="Manhã">Manhã</option>
                    <option value="Tarde">Tarde</option>
                    <option value="Noite">Noite</option>
                </select>
            </div>
            <button id="exportBtn">Exportar Respostas (Excel)</button>
            <button id="clearBtn">Limpar Respostas</button>
        </section>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        (function(){
            emailjs.init("vEDLCBUCj49wwAh96");
        })();

        let nome, emailAluno, turma, periodo;
        let questions = [];
        let currentQuestion = 0;
        let respostas = {};
        let timerInterval;
        let allStudentAnswers = localStorage.getItem('allStudentAnswers') ? JSON.parse(localStorage.getItem('allStudentAnswers')) : [];
        let isProfessor = false;

        // Respostas corretas originais (antes do embaralhamento)
        const originalCorrectAnswers = {
            opMicroQ1: 'b', opMicroQ2: 'b', opMicroQ3: 'b', opMicroQ4: 'a', opMicroQ5: 'a',
            opMicroQ6: 'b', opMicroQ7: 'a', opMicroQ8: 'b', opMicroQ9: 'b', opMicroQ10: 'a',
            opMicroQ11: 'a', opMicroQ12: 'a', opMicroQ13: 'a', opMicroQ14: 'b', opMicroQ15: 'a',
            opMicroQ16: 'a', opMicroQ17: 'a', opMicroQ18: 'a', opMicroQ19: 'a', opMicroQ20: 'a'
        };
        let correctAnswers = { ...originalCorrectAnswers }; // Cópia que será ajustada após embaralhamento

        // Função para embaralhar um array (Fisher-Yates)
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        document.getElementById('studentBtn').addEventListener('click', function() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dadosSection').style.display = 'block';
        });

        document.getElementById('professorBtn').addEventListener('click', function() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('passwordSection').style.display = 'block';
        });

        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('profPassword').value;
            if (password === 'prof123') {
                isProfessor = true;
                document.getElementById('passwordSection').style.display = 'none';
                document.getElementById('professorSection').style.display = 'block';
            } else {
                alert('Senha incorreta. Tente novamente.');
            }
        });

        function startTimer() {
            let timeLeft = 60 * 60;
            const timerDisplay = document.getElementById('timer');
            timerDisplay.style.display = 'block';

            timerInterval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

                if (timeLeft === 300) {
                    timerDisplay.style.background = '#A74A86';
                    alert('Atenção: Restam 5 minutos para o término da prova!');
                }
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    sendProva(false);
                }
                timeLeft--;
            }, 1000);
        }

        function calculateScore(respostas) {
            let score = 0;
            for (let i = 1; i <= 20; i++) {
                const questionId = `opMicroQ${i}`;
                if (respostas[questionId] === correctAnswers[questionId]) {
                    score += 0.5;
                }
            }
            return score;
        }

        function sendProva(manual = true) {
            if (manual && !confirm('Deseja enviar a prova agora? Suas respostas serão enviadas como estão.')) {
                return;
            }

            const score = calculateScore(respostas);
            const studentData = {
                nome: nome,
                email: emailAluno,
                turma: turma,
                periodo: periodo,
                respostas: { ...respostas },
                notaFinal: score
            };

            allStudentAnswers.push(studentData);
            localStorage.setItem('allStudentAnswers', JSON.stringify(allStudentAnswers));

            emailjs.send("service_2ag71hm", "template_tn8690e", {
                nome: nome,
                turma: turma,
                periodo: periodo,
                q1: respostas['opMicroQ1'] || '',
                q2: respostas['opMicroQ2'] || '',
                q3: respostas['opMicroQ3'] || '',
                q4: respostas['opMicroQ4'] || '',
                q5: respostas['opMicroQ5'] || '',
                q6: respostas['opMicroQ6'] || '',
                q7: respostas['opMicroQ7'] || '',
                q8: respostas['opMicroQ8'] || '',
                q9: respostas['opMicroQ9'] || '',
                q10: respostas['opMicroQ10'] || '',
                q11: respostas['opMicroQ11'] || '',
                q12: respostas['opMicroQ12'] || '',
                q13: respostas['opMicroQ13'] || '',
                q14: respostas['opMicroQ14'] || '',
                q15: respostas['opMicroQ15'] || '',
                q16: respostas['opMicroQ16'] || '',
                q17: respostas['opMicroQ17'] || '',
                q18: respostas['opMicroQ18'] || '',
                q19: respostas['opMicroQ19'] || '',
                q20: respostas['opMicroQ20'] || '',
                from_email: emailAluno,
                to_email: 'wsbatistaprof@gmail.com'
            })
            .then(function(response) {
                alert(`Prova enviada com sucesso! Sua nota: ${score}/10. Verifique seu e-mail.`);
                resetProva();
            }, function(error) {
                alert('Erro ao enviar a prova. Verifique sua conexão ou tente novamente.');
                console.log('Erro:', error);
            });
        }

        function resetProva() {
            clearInterval(timerInterval);
            document.getElementById('timer').style.display = 'none';
            document.getElementById('timer').style.background = '#CD6E27';
            document.getElementById('dadosForm').reset();
            document.getElementById('perguntasSection').style.display = 'none';
            document.getElementById('dadosSection').style.display = 'block';
            questions.forEach(q => q.classList.remove('active'));
            document.getElementById('progress').textContent = '';
            currentQuestion = 0;
            document.getElementById('prevBtn').style.display = 'none';
            document.getElementById('finishBtn').style.display = 'none';
            questions.forEach(q => {
                const radios = q.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => radio.checked = false);
            });
            respostas = {};
            correctAnswers = { ...originalCorrectAnswers }; // Reseta as respostas corretas para o original
            window.onbeforeunload = null;
        }

        document.getElementById('dadosForm').addEventListener('submit', function(e) {
            e.preventDefault();

            nome = document.getElementById('nome').value;
            emailAluno = document.getElementById('email').value;
            turma = document.getElementById('turma').value;
            periodo = document.getElementById('periodo').value;

            if (!emailAluno.includes('@') || !emailAluno.includes('.')) {
                alert('Por favor, insira um e-mail válido.');
                return;
            }

            questions = Array.from(document.querySelectorAll('.question'));

            // Embaralhar as questões
            questions = shuffle(questions);
            const perguntasSection = document.getElementById('perguntasSection');
            const navigationDiv = perguntasSection.querySelector('.navigation');
            perguntasSection.innerHTML = ''; // Limpa o conteúdo atual
            perguntasSection.appendChild(document.createElement('div')).className = 'title-section';
            perguntasSection.querySelector('.title-section').textContent = 'Prova de Avaliação de Conhecimentos';
            perguntasSection.appendChild(document.createElement('h1')).textContent = 'Prova Online';
            perguntasSection.appendChild(document.createElement('div')).id = 'progress';
            questions.forEach(q => perguntasSection.appendChild(q)); // Adiciona questões embaralhadas
            perguntasSection.appendChild(navigationDiv); // Reinsere o navigation

            // Embaralhar as alternativas de cada questão
            questions.forEach((question, index) => {
                const optionsDiv = question.querySelector('.options');
                let options = Array.from(optionsDiv.querySelectorAll('label'));
                const originalCorrectValue = originalCorrectAnswers[question.id];
                const originalCorrectIndex = options.findIndex(opt => opt.querySelector('input').value === originalCorrectValue);

                options = shuffle(options);
                optionsDiv.innerHTML = '';
                options.forEach((opt, newIndex) => {
                    const input = opt.querySelector('input');
                    input.value = String.fromCharCode(97 + newIndex); // Atualiza valores para 'a', 'b', 'c', 'd'
                    opt.querySelector('input').name = question.id; // Garante que o name seja único
                    optionsDiv.appendChild(opt);
                });

                // Atualiza a resposta correta no objeto correctAnswers
                const newCorrectValue = options[originalCorrectIndex].querySelector('input').value;
                correctAnswers[question.id] = newCorrectValue;
                console.log(`Questão ${question.id}: Resposta correta atualizada para ${newCorrectValue}`);
            });

            console.log('Total de questões carregadas:', questions.length);
            document.getElementById('dadosSection').style.display = 'none';
            document.getElementById('perguntasSection').style.display = 'block';
            questions[currentQuestion].classList.add('active');
            document.getElementById('progress').textContent = `Questão 1 de ${questions.length}`;
            startTimer();

            window.onbeforeunload = function() {
                return 'Você tem certeza que quer sair? Suas respostas podem ser perdidas.';
            };
        });

        const prevBtn = document.getElementById('prevBtn');
        const finishBtn = document.getElementById('finishBtn');

        document.querySelectorAll('.submitAnswer').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const currentQuestionDiv = button.closest('.question');
                if (!currentQuestionDiv) {
                    console.error('Div da questão não encontrada');
                    return;
                }

                const questionId = currentQuestionDiv.id;
                const selectedOption = currentQuestionDiv.querySelector('input[type="radio"]:checked');

                if (!selectedOption) {
                    alert('Por favor, selecione uma opção antes de enviar.');
                    return;
                }

                respostas[questionId] = selectedOption.value;
                console.log(`Resposta registrada - Questão: ${questionId}, Valor: ${respostas[questionId]}, Total de respostas: ${Object.keys(respostas).length}`);

                if (currentQuestion < questions.length - 1) {
                    questions[currentQuestion].classList.remove('active');
                    currentQuestion++;
                    questions[currentQuestion].classList.add('active');
                    document.getElementById('progress').textContent = `Questão ${currentQuestion + 1} de ${questions.length}`;
                    prevBtn.style.display = 'block';
                    finishBtn.style.display = currentQuestion === questions.length - 1 ? 'block' : 'none';
                    console.log(`Avançou para questão ${currentQuestion + 1}, ID: ${questions[currentQuestion].id}`);
                } else {
                    console.log('Última questão alcançada');
                }
            });
        });

        prevBtn.addEventListener('click', function() {
            if (currentQuestion > 0) {
                questions[currentQuestion].classList.remove('active');
                currentQuestion--;
                questions[currentQuestion].classList.add('active');
                document.getElementById('progress').textContent = `Questão ${currentQuestion + 1} de ${questions.length}`;
                if (currentQuestion === 0) {
                    prevBtn.style.display = 'none';
                }
                finishBtn.style.display = currentQuestion === questions.length - 1 ? 'block' : 'none';
                console.log(`Voltou para questão ${currentQuestion + 1}, ID: ${questions[currentQuestion].id}`);
            }
        });

        finishBtn.addEventListener('click', function() {
            const lastQuestionDiv = questions[questions.length - 1];
            const lastQuestionId = lastQuestionDiv.id;
            const selectedOption = lastQuestionDiv.querySelector('input[type="radio"]:checked');

            if (!selectedOption) {
                alert('Por favor, selecione uma opção na última questão antes de finalizar.');
                return;
            }

            respostas[lastQuestionId] = selectedOption.value;
            console.log(`Resposta final registrada - Questão: ${lastQuestionId}, Valor: ${respostas[lastQuestionId]}`);
            sendProva(true);
        });

        document.getElementById('exportBtn').addEventListener('click', function() {
            if (!window.XLSX) {
                alert('Erro: A biblioteca XLSX não foi carregada. Verifique sua conexão ou tente recarregar a página.');
                return;
            }

            if (allStudentAnswers.length === 0) {
                alert('Nenhuma resposta disponível para exportar.');
                return;
            }

            const selectedTurma = document.getElementById('exportTurma').value;
            const selectedPeriodo = document.getElementById('exportPeriodo').value;
            let filteredAnswers = [...allStudentAnswers];

            if (selectedTurma) {
                filteredAnswers = filteredAnswers.filter(student => student.turma === selectedTurma);
            }
            if (selectedPeriodo) {
                filteredAnswers = filteredAnswers.filter(student => student.periodo === selectedPeriodo);
            }

            if (filteredAnswers.length === 0) {
                alert('Nenhuma resposta encontrada para os filtros selecionados.');
                return;
            }

            try {
                const data = filteredAnswers.map(student => ({
                    'Nome do Aluno': student.nome,
                    'Turma': student.turma,
                    'Período': student.periodo,
                    'Nota Final': student.notaFinal
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Respostas");

                const fileName = `respostas_${selectedTurma || 'todas_turmas'}_${selectedPeriodo || 'todos_periodos'}.xlsx`;
                XLSX.writeFile(wb, fileName);
                alert('Respostas exportadas com sucesso!');
            } catch (error) {
                console.error('Erro ao exportar respostas:', error);
                alert('Erro ao exportar as respostas. Verifique o console para mais detalhes.');
            }
        });

        document.getElementById('clearBtn').addEventListener('click', function() {
            if (confirm('Tem certeza que deseja limpar todas as respostas salvas? Esta ação não pode ser desfeita.')) {
                localStorage.clear();
                allStudentAnswers = [];
                alert('Respostas limpas com sucesso!');
            }
        });
    </script>
</body>
</html>